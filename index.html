<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Shake Color App</title>
  <meta name="theme-color" content="#333333" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Shake Color">
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <link rel="apple-touch-icon" href="icon-192.png">
  <style>
    html, body { 
      height: 100%; 
      margin: 0; 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }
    body {
      background: #333333;
      color: #fff;
      overflow: hidden;
      touch-action: manipulation;
      user-select: none;
      transition: none;
    }
    .container {
      width: 100vw; 
      height: 100vh; 
      position: relative;
      display: flex; 
      align-items: center; 
      justify-content: center;
      flex-direction: column;
    }
    .start {
      background: #00d867; 
      color: #000; 
      font-weight: 700; 
      border: 0; 
      border-radius: 20px;
      padding: 25px 40px; 
      font-size: 22px; 
      box-shadow: 0 8px 30px rgba(0,216,103,.4);
      cursor: pointer;
      z-index: 10;
    }
    .text-top {
      position: absolute;
      top: 30px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 28px;
      font-weight: 900;
      letter-spacing: 3px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
      z-index: 5;
    }
    .text-bottom {
      position: absolute;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 28px;
      font-weight: 900;
      letter-spacing: 3px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
      z-index: 5;
    }
    .hide { 
      display: none; 
    }
    @media (max-width: 480px) {
      .text-top, .text-bottom {
        font-size: 24px;
        letter-spacing: 2px;
      }
      .start {
        padding: 20px 35px;
        font-size: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="container" id="container">
    <div class="text-top hide" id="textTop">SECOUEZ MOI</div>
    <button class="start" id="startBtn">ðŸš€ DÃ‰MARRER</button>
    <div class="text-bottom hide" id="textBottom">SHAKE ME</div>
  </div>

  <script>
    const container = document.getElementById('container');
    const startBtn = document.getElementById('startBtn');
    const textTop = document.getElementById('textTop');
    const textBottom = document.getElementById('textBottom');

    let running = false;
    let lastTS = 0;
    let flashInterval = null;

    // Estimation gravitÃ© avec plus de lissage
    const gravity = { x: 0, y: 0, z: 0 };
    const alpha = 0.95; // â†‘ Plus de lissage = moins sensible

    // Lissage magnitude avec plus de stabilitÃ©
    let smoothMagnitude = 0;
    const magSmoothAlpha = 0.8; // â†‘ Plus de lissage

    // Seuils beaucoup plus Ã©levÃ©s
    const SLOW_MOVE_THRESHOLD = 1.2; // â†‘ Il faut vraiment bouger pour dÃ©clencher
    const SHAKE_THRESHOLD = 4.5; // â†‘ Secousse forte nÃ©cessaire

    // SystÃ¨me de progression pour les secousses (5-8 secondes)
    let shakeIntensity = 0;
    let shakeStartTime = 0;
    let isShaking = false;
    let shakeTimeout = null;

    // Progression des couleurs sur 6 secondes
    const shakeColors = [
      '#333333', // gris (0s)
      '#00ff00', // vert (1s)
      '#ffff00', // jaune (2s)
      '#ffa500', // orange (3s)
      '#ff4500', // rouge-orange (4s)
      '#ff0000', // rouge (5s)
      '#ffffff'  // blanc (6s)
    ];

    // Couleurs arc-en-ciel pour le flash
    const rainbowColors = [
      '#ff0000', '#ff4500', '#ffa500', '#ffff00', 
      '#9aff9a', '#00ff00', '#00ffff', '#0080ff', 
      '#0000ff', '#8000ff', '#ff00ff', '#ff1493'
    ];
    let colorIndex = 0;

    function start(){
      startBtn.classList.add('hide');
      textTop.classList.remove('hide');
      textBottom.classList.remove('hide');
      running = true;

      if (navigator.vibrate) navigator.vibrate(60);

      if (window.DeviceMotionEvent) {
        if (typeof DeviceMotionEvent.requestPermission === 'function') {
          DeviceMotionEvent.requestPermission().then(state => {
            if (state === 'granted') attachMotion(); else enableTouchFallback();
          }).catch(enableTouchFallback);
        } else {
          attachMotion();
        }
      } else {
        enableTouchFallback();
      }
    }

    function attachMotion(){
      window.addEventListener('devicemotion', onMotion, {passive: true});
    }

    function enableTouchFallback(){
      let tapCount = 0;
      let tapTimer = null;

      container.addEventListener('touchstart', (e) => {
        e.preventDefault();
        tapCount++;

        clearTimeout(tapTimer);
        tapTimer = setTimeout(() => {
          if (tapCount === 1) {
            // Tap simple = mouvement lent
            triggerSlowMovement();
          } else if (tapCount >= 3) {
            // Triple tap ou plus = secousse
            triggerShake();
          }
          tapCount = 0;
        }, 400);
      }, {passive: false});
    }

    function triggerSlowMovement() {
      if (!isShaking) {
        startRainbowFlash();
        setTimeout(stopRainbowFlash, 2000); // Flash pendant 2s
      }
    }

    function triggerShake() {
      startShakeSequence();
      if (navigator.vibrate) navigator.vibrate(100);
    }

    function onMotion(e){
      if (!running) return;

      const a = e.accelerationIncludingGravity || e.acceleration;
      if (!a) return;

      const now = e.timeStamp ? e.timeStamp : performance.now();
      if (!lastTS) lastTS = now;
      const dt = (now - lastTS) / 1000;
      lastTS = now;

      // Filtre gravitÃ© avec plus de lissage
      gravity.x = alpha*gravity.x + (1-alpha)*(a.x||0);
      gravity.y = alpha*gravity.y + (1-alpha)*(a.y||0);
      gravity.z = alpha*gravity.z + (1-alpha)*(a.z||0);

      const lx = (a.x||0) - gravity.x;
      const ly = (a.y||0) - gravity.y;
      const lz = (a.z||0) - gravity.z;

      const mag = Math.sqrt(lx*lx + ly*ly + lz*lz);

      // Lissage plus fort de la magnitude
      smoothMagnitude = magSmoothAlpha*smoothMagnitude + (1-magSmoothAlpha)*mag;

      // Logique de dÃ©tection avec seuils plus Ã©levÃ©s
      if (smoothMagnitude > SHAKE_THRESHOLD) {
        // Secousse dÃ©tectÃ©e - dÃ©marrer ou continuer la sÃ©quence
        if (!isShaking) {
          startShakeSequence();
          if (navigator.vibrate) navigator.vibrate(50);
        }
        // Reset du timeout d'arrÃªt
        clearTimeout(shakeTimeout);
        shakeTimeout = setTimeout(stopShakeSequence, 800); // â†‘ Plus de tolÃ©rance

      } else if (smoothMagnitude > SLOW_MOVE_THRESHOLD && smoothMagnitude <= SHAKE_THRESHOLD) {
        // Mouvement lent - flash arc-en-ciel (seulement si pas en mode secousse)
        if (!isShaking && !flashInterval) {
          startRainbowFlash();
        }
      } else {
        // Immobile ou mouvement trÃ¨s faible
        if (!isShaking) {
          stopRainbowFlash();
        }
      }
    }

    function startRainbowFlash() {
      if (flashInterval || isShaking) return;

      flashInterval = setInterval(() => {
        container.style.backgroundColor = rainbowColors[colorIndex];
        colorIndex = (colorIndex + 1) % rainbowColors.length;
      }, 100); // Flash toutes les 100ms
    }

    function stopRainbowFlash() {
      if (flashInterval) {
        clearInterval(flashInterval);
        flashInterval = null;
        if (!isShaking) {
          container.style.backgroundColor = '#333333'; // Retour au gris
        }
      }
    }

    function startShakeSequence() {
      if (isShaking) return; // DÃ©jÃ  en cours

      isShaking = true;
      shakeStartTime = Date.now();
      shakeIntensity = 0;
      stopRainbowFlash(); // ArrÃªter le flash arc-en-ciel

      // DÃ©marrer la progression des couleurs
      updateShakeColor();
    }

    function updateShakeColor() {
      if (!isShaking) return;

      const elapsed = (Date.now() - shakeStartTime) / 1000; // secondes Ã©coulÃ©es
      const maxDuration = 6; // 6 secondes pour atteindre le blanc

      // Calculer l'index de couleur basÃ© sur le temps
      const progress = Math.min(elapsed / maxDuration, 1);
      const colorIndex = Math.floor(progress * (shakeColors.length - 1));

      container.style.backgroundColor = shakeColors[colorIndex];

      // Continuer la progression si pas encore au blanc
      if (progress < 1) {
        setTimeout(updateShakeColor, 100); // Mise Ã  jour toutes les 100ms
      }
    }

    function stopShakeSequence() {
      isShaking = false;
      container.style.backgroundColor = '#333333'; // Retour instantanÃ© au gris
      clearTimeout(shakeTimeout);
      shakeIntensity = 0;
    }

    // DÃ©marrage
    startBtn.addEventListener('click', start, {passive: true});

    // Nettoyage pÃ©riodique plus espacÃ©
    setInterval(() => {
      if (!running) return;
      if (!isShaking && !flashInterval && smoothMagnitude < SLOW_MOVE_THRESHOLD * 0.5) {
        container.style.backgroundColor = '#333333';
      }
    }, 500); // â†‘ Moins frÃ©quent

    // PWA - Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js');
      });
    }

    // EmpÃªcher zoom et scroll
    document.addEventListener('touchmove', (e) => e.preventDefault(), {passive: false});
    document.addEventListener('gesturestart', (e) => e.preventDefault());
  </script>
</body>
</html>