<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Shake Color App</title>
  <meta name="theme-color" content="#333333" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Shake Color">
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <link rel="apple-touch-icon" href="icon-192.png">
  <style>
    html, body { height: 100%; margin: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #333;
      color: #fff;
      overflow: hidden;
      touch-action: manipulation;
      user-select: none;
      transition: background-color .15s linear;
    }
    .container {
      width: 100vw; height: 100vh; position: relative;
      display: flex; align-items: center; justify-content: center;
    }
    .start {
      position: absolute; z-index: 10; top: 50%; left: 50%; transform: translate(-50%,-50%);
      background: #00d867; color: #000; font-weight: 700; border: 0; border-radius: 14px;
      padding: 18px 26px; font-size: 18px; box-shadow: 0 8px 30px rgba(0,216,103,.3);
      cursor: pointer;
    }
    .panel {
      position: absolute; left: 12px; right: 12px; top: 12px;
      background: rgba(0,0,0,.45); border-radius: 14px; padding: 12px; text-align: center;
      font-size: 14px; line-height: 1.35; backdrop-filter: blur(8px);
    }
    .status {
      position: absolute; bottom: 14px; left: 50%; transform: translateX(-50%);
      background: rgba(0,0,0,.45); border-radius: 22px; padding: 10px 16px; backdrop-filter: blur(8px);
      font-size: 14px; min-width: 260px; text-align: center;
    }
    .row { display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-top:6px; }
    .pill { background: rgba(255,255,255,.12); padding: 6px 10px; border-radius: 999px; font-variant-numeric: tabular-nums; }
    .hide{ display:none; }
  </style>
</head>
<body>
  <div class="container" id="container">
    <div class="panel">
      <div><b>ðŸŽ¨ Shake Color App</b></div>
      <div>â€¢ Mouvement lent: arc-en-ciel fluide</div>
      <div>â€¢ Secousses: la <b>frÃ©quence</b> transforme la couleur</div>
      <div class="row">
        <span class="pill">SensibilitÃ© optimisÃ©e</span>
        <span class="pill">DÃ©tection de pics</span>
        <span class="pill">FenÃªtre glissante</span>
      </div>
    </div>
    <button class="start" id="startBtn">DÃ©marrer</button>
    <div class="status hide" id="status">PrÃªt</div>
  </div>

  <script>
    const container = document.getElementById('container');
    const startBtn = document.getElementById('startBtn');
    const statusEl = document.getElementById('status');

    let running = false;
    let lastTS = 0;

    // Estimation de la gravitÃ© (LPF) et accÃ©lÃ©ration linÃ©aire
    const gravity = { x: 0, y: 0, z: 0 };
    const alpha = 0.9; // lissage gravitÃ©

    // Lissage pour l'Ã©nergie de mouvement
    let smoothMagnitude = 0;
    const magSmoothAlpha = 0.7;

    // DÃ©tection de secousses (pics)
    const SHAKE_PEAK_THRESHOLD = 2.8; // â†‘ moins sensible
    const MIN_PEAK_INTERVAL = 300;    // ms, â†‘ Ã©vite double comptage
    let lastPeakTime = 0;

    // FenÃªtre glissante
    const WINDOW_MS = 5000; // 5s
    let shakeTimes = [];

    // Plage de "mouvement lent" (entre immobile et fort)
    const SLOW_MOVE_LOW = 0.20;  // â†‘ ignore micro-mouvements
    const SLOW_MOVE_HIGH = 1.20; // â†‘ seuil haut du lent

    // Couleurs
    const COLORS = {
      green: [0, 255, 0],
      red: [255, 0, 0],
      yellow: [255, 255, 0],
      white: [255, 255, 255],
    };

    function lerp(a,b,t){ return a + (b-a)*t; }
    function lerpColor(c1, c2, t){
      return `rgb(${Math.round(lerp(c1[0], c2[0], t))}, ${Math.round(lerp(c1[1], c2[1], t))}, ${Math.round(lerp(c1[2], c2[2], t))})`;
    }

    // Palette green -> red -> yellow -> white selon la frÃ©quence des secousses
    function colorFromProgress(p){
      const stops = [COLORS.green, COLORS.red, COLORS.yellow, COLORS.white];
      const n = stops.length - 1;
      const x = Math.max(0, Math.min(1, p)) * n;
      const i = Math.floor(x);
      const t = x - i;
      return lerpColor(stops[i], stops[i+1] || stops[n], t);
    }

    // Arc-en-ciel pour mouvement lent (hue cyclique)
    function rainbowSlow(t, strength){
      const hue = (t * (20 + 100*strength)) % 360;
      const light = 40 + Math.round(30*strength);
      return `hsl(${Math.round(hue)}, 100%, ${light}%)`;
    }

    function start(){
      startBtn.classList.add('hide');
      statusEl.classList.remove('hide');
      running = true;
      if (navigator.vibrate) navigator.vibrate(60);

      if (window.DeviceMotionEvent) {
        if (typeof DeviceMotionEvent.requestPermission === 'function') {
          DeviceMotionEvent.requestPermission().then(state => {
            if (state === 'granted') attachMotion(); else enableTouchFallback();
          }).catch(enableTouchFallback);
        } else {
          attachMotion();
        }
      } else {
        enableTouchFallback();
      }
    }

    function attachMotion(){
      window.addEventListener('devicemotion', onMotion, {passive: true});
      statusEl.textContent = 'Capteur actif â€“ secouez ou bougez lentement';
    }

    function enableTouchFallback(){
      statusEl.textContent = 'Mode tactile: tapotez pour simuler des secousses';
      let taps = 0; let timer;
      container.addEventListener('touchstart', () => {
        taps++;
        clearTimeout(timer);
        timer = setTimeout(()=>{
          const now = Date.now();
          for (let i=0;i<taps;i++) shakeTimes.push(now);
          pruneWindow();
          updateByShakes(now);
          taps = 0;
        }, 300);
      }, {passive:true});
    }

    function onMotion(e){
      const a = e.accelerationIncludingGravity || e.acceleration;
      if (!a) return;

      const now = e.timeStamp ? e.timeStamp : performance.now();
      if (!lastTS) lastTS = now;
      lastTS = now;

      // Filtre gravitÃ© et accÃ©lÃ©ration linÃ©aire
      gravity.x = alpha*gravity.x + (1-alpha)*(a.x||0);
      gravity.y = alpha*gravity.y + (1-alpha)*(a.y||0);
      gravity.z = alpha*gravity.z + (1-alpha)*(a.z||0);

      const lx = (a.x||0) - gravity.x;
      const ly = (a.y||0) - gravity.y;
      const lz = (a.z||0) - gravity.z;

      const mag = Math.sqrt(lx*lx + ly*ly + lz*lz);

      // Lissage magnitude
      smoothMagnitude = magSmoothAlpha*smoothMagnitude + (1-magSmoothAlpha)*mag;

      // DÃ©tection de pics (secousses)
      const nowMs = performance.now();
      if (smoothMagnitude > SHAKE_PEAK_THRESHOLD && (nowMs - lastPeakTime) > MIN_PEAK_INTERVAL){
        lastPeakTime = nowMs;
        shakeTimes.push(nowMs);
        if (navigator.vibrate) navigator.vibrate(8);
      }

      pruneWindow();
      updateColor(nowMs);
    }

    function pruneWindow(){
      const cutoff = performance.now() - WINDOW_MS;
      while (shakeTimes.length && shakeTimes[0] < cutoff) shakeTimes.shift();
    }

    function shakesRate(){
      // normalise le nombre de secousses (5s)
      const count = shakeTimes.length;
      const MAX_SHAKES = 16; // ~3.2 Hz saturÃ©
      return Math.max(0, Math.min(1, count / MAX_SHAKES));
    }

    function updateColor(nowMs){
      const rate = shakesRate();

      if (rate < 0.15) {
        // Mouvement lent -> arc-en-ciel
        if (smoothMagnitude > SLOW_MOVE_LOW && smoothMagnitude < SLOW_MOVE_HIGH) {
          const slowStrength = Math.max(0, Math.min(1, (smoothMagnitude - SLOW_MOVE_LOW) / (SLOW_MOVE_HIGH - SLOW_MOVE_LOW)));
          const color = rainbowSlow(nowMs/1000, slowStrength);
          container.style.backgroundColor = color;
          statusEl.textContent = `Mouvement lent Â· intensitÃ© ${slowStrength.toFixed(2)} Â· arc-en-ciel`;
        } else if (smoothMagnitude >= SLOW_MOVE_HIGH) {
          container.style.backgroundColor = 'hsl(80, 100%, 55%)';
          statusEl.textContent = 'Mouvement fort continu';
        } else {
          container.style.backgroundColor = 'rgb(51,51,51)';
          statusEl.textContent = 'ImmobilitÃ©';
        }
      } else {
        // Secousses -> progression par frÃ©quence
        const color = colorFromProgress(rate);
        container.style.backgroundColor = color;
        statusEl.textContent = `Secousses: ${shakeTimes.length} / 5s Â· progression ${(rate*100)|0}%`;
      }
    }

    function updateByShakes(){
      const rate = shakesRate();
      if (rate <= 0) {
        container.style.backgroundColor = 'rgb(51,51,51)';
        statusEl.textContent = 'ImmobilitÃ© (tactile)';
      } else {
        container.style.backgroundColor = colorFromProgress(rate);
        statusEl.textContent = `Secousses (tactile): ${shakeTimes.length} / 5s`;
      }
    }

    // DÃ©marrage
    startBtn.addEventListener('click', start, {passive:true});

    // Tendance vers gris au repos
    setInterval(()=>{
      if (!running) return;
      if (shakeTimes.length === 0 && smoothMagnitude < SLOW_MOVE_LOW*0.8) {
        container.style.backgroundColor = 'rgb(51,51,51)';
        statusEl.textContent = 'Repos';
      }
    }, 500);

    // PWA - enregistrement du Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js');
      });
    }
  </script>
</body>
</html>