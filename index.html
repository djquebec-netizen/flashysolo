<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Shake Color App</title>
  <meta name="theme-color" content="#333333" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Shake Color">
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <link rel="apple-touch-icon" href="icon-192.png">
  <style>
    html, body { 
      height: 100%; 
      margin: 0; 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }
    body {
      background: #000000;
      color: #fff;
      overflow: hidden;
      touch-action: manipulation;
      user-select: none;
      transition: none;
    }
    .container {
      width: 100vw; 
      height: 100vh; 
      position: relative;
      display: flex; 
      align-items: center; 
      justify-content: center;
      flex-direction: column;
    }
    .start {
      background: #00d867; 
      color: #000; 
      font-weight: 700; 
      border: 0; 
      border-radius: 20px;
      padding: 25px 40px; 
      font-size: 22px; 
      box-shadow: 0 8px 30px rgba(0,216,103,.4);
      cursor: pointer;
      z-index: 10;
    }
    .text-top {
      position: absolute;
      top: 30px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 28px;
      font-weight: 900;
      letter-spacing: 3px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
      z-index: 5;
    }
    .text-bottom {
      position: absolute;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 28px;
      font-weight: 900;
      letter-spacing: 3px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
      z-index: 5;
    }
    .reset-btn {
      position: absolute;
      bottom: 20px;
      right: 20px;
      background: rgba(255,255,255,0.1);
      color: rgba(255,255,255,0.6);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 12px;
      cursor: pointer;
      z-index: 10;
      transition: all 0.2s ease;
    }
    .reset-btn:hover {
      background: rgba(255,255,255,0.2);
      color: rgba(255,255,255,0.8);
    }
    .hide { 
      display: none; 
    }
    @media (max-width: 480px) {
      .text-top, .text-bottom {
        font-size: 24px;
        letter-spacing: 2px;
      }
      .start {
        padding: 20px 35px;
        font-size: 20px;
      }
      .reset-btn {
        font-size: 11px;
        padding: 6px 10px;
      }
    }
  </style>
</head>
<body>
  <div class="container" id="container">
    <div class="text-top hide" id="textTop">SECOUEZ MOI</div>
    <button class="start" id="startBtn">ðŸš€ DÃ‰MARRER</button>
    <div class="text-bottom hide" id="textBottom">SHAKE ME</div>
    <button class="reset-btn hide" id="resetBtn">â†» Reset</button>
  </div>

  <script>
    const container = document.getElementById('container');
    const startBtn = document.getElementById('startBtn');
    const textTop = document.getElementById('textTop');
    const textBottom = document.getElementById('textBottom');
    const resetBtn = document.getElementById('resetBtn');

    let running = false;
    let lastTS = 0;
    let flashInterval = null;
    let progressionInterval = null;
    let whiteTimeout = null;

    // Estimation gravitÃ©
    const gravity = { x: 0, y: 0, z: 0 };
    const alpha = 0.9;

    // Lissage magnitude
    let smoothMagnitude = 0;
    const magSmoothAlpha = 0.7;

    // DÃ©tection de la "fluiditÃ©" vs "saccadÃ©"
    let magnitudeHistory = [];
    const HISTORY_SIZE = 10;
    let jerkiness = 0;

    // Seuils
    const MIN_MOVEMENT = 0.8;
    const JERKINESS_THRESHOLD = 1.5;

    // Ã‰tats
    let currentMode = 'idle'; // 'idle', 'smooth', 'jerky', 'white_hold'
    let modeTimeout = null;
    let jerkyStartTime = 0;
    let jerkyStep = 0;

    // 20 couleurs arc-en-ciel pour mouvement fluide
    const rainbowColors = [
      '#ff0000', '#ff4400', '#ff8800', '#ffcc00', '#ffff00',
      '#ccff00', '#88ff00', '#44ff00', '#00ff00', '#00ff44',
      '#00ff88', '#00ffcc', '#00ffff', '#00ccff', '#0088ff',
      '#0044ff', '#0000ff', '#4400ff', '#8800ff', '#cc00ff'
    ];
    let colorIndex = 0;

    // 20 couleurs pour mouvement saccadÃ© (0.5s chacune = 10s total)
    const jerkyColors = [
      '#333333', // gris (0s)
      '#004400', '#006600', '#008800', '#00aa00', '#00cc00', // verts progressifs
      '#00ff00', '#22ff00', '#44ff00', '#66ff00', '#88ff00', // vert vers jaune
      '#aaff00', '#ccff00', '#eeff00', '#ffff00', '#ffcc00', // jaunes/oranges
      '#ff9900', '#ff6600', '#ff3300', '#ff0000', // oranges/rouges
      '#ffffff'  // blanc final (10s)
    ];

    function start(){
      startBtn.classList.add('hide');
      textTop.classList.remove('hide');
      textBottom.classList.remove('hide');
      resetBtn.classList.remove('hide');
      running = true;

      if (navigator.vibrate) navigator.vibrate(60);

      if (window.DeviceMotionEvent) {
        if (typeof DeviceMotionEvent.requestPermission === 'function') {
          DeviceMotionEvent.requestPermission().then(state => {
            if (state === 'granted') attachMotion(); else enableTouchFallback();
          }).catch(enableTouchFallback);
        } else {
          attachMotion();
        }
      } else {
        enableTouchFallback();
      }
    }

    function reset() {
      stopAllModes();
      container.style.backgroundColor = '#000000';
      currentMode = 'idle';
      if (navigator.vibrate) navigator.vibrate(30);
    }

    function attachMotion(){
      window.addEventListener('devicemotion', onMotion, {passive: true});
    }

    function enableTouchFallback(){
      let touchStartTime = 0;
      let touchMoveCount = 0;
      let touchTimer = null;

      container.addEventListener('touchstart', (e) => {
        if (e.target === resetBtn) return; // Ne pas interfÃ©rer avec le bouton reset
        e.preventDefault();
        touchStartTime = Date.now();
        touchMoveCount = 0;
      }, {passive: false});

      container.addEventListener('touchmove', (e) => {
        e.preventDefault();
        touchMoveCount++;
      }, {passive: false});

      container.addEventListener('touchend', (e) => {
        if (e.target === resetBtn) return;
        e.preventDefault();
        const duration = Date.now() - touchStartTime;

        clearTimeout(touchTimer);

        if (duration > 100) {
          if (touchMoveCount > 20) {
            startJerkyMode();
          } else if (touchMoveCount > 5) {
            startSmoothMode();
          }
        }

        touchTimer = setTimeout(() => {
          if (currentMode !== 'white_hold') {
            stopAllModes();
          }
        }, 800);
      }, {passive: false});
    }

    function onMotion(e){
      if (!running || currentMode === 'white_hold') return;

      const a = e.accelerationIncludingGravity || e.acceleration;
      if (!a) return;

      const now = e.timeStamp ? e.timeStamp : performance.now();
      if (!lastTS) lastTS = now;
      const dt = (now - lastTS) / 1000;
      lastTS = now;

      // Filtre gravitÃ©
      gravity.x = alpha*gravity.x + (1-alpha)*(a.x||0);
      gravity.y = alpha*gravity.y + (1-alpha)*(a.y||0);
      gravity.z = alpha*gravity.z + (1-alpha)*(a.z||0);

      const lx = (a.x||0) - gravity.x;
      const ly = (a.y||0) - gravity.y;
      const lz = (a.z||0) - gravity.z;

      const mag = Math.sqrt(lx*lx + ly*ly + lz*lz);
      smoothMagnitude = magSmoothAlpha*smoothMagnitude + (1-magSmoothAlpha)*mag;

      // Garder un historique pour calculer la "fluiditÃ©"
      magnitudeHistory.push(smoothMagnitude);
      if (magnitudeHistory.length > HISTORY_SIZE) {
        magnitudeHistory.shift();
      }

      // Calculer la "saccade" (variance des changements)
      if (magnitudeHistory.length >= 3) {
        let variations = 0;
        for (let i = 1; i < magnitudeHistory.length - 1; i++) {
          const change1 = Math.abs(magnitudeHistory[i] - magnitudeHistory[i-1]);
          const change2 = Math.abs(magnitudeHistory[i+1] - magnitudeHistory[i]);
          variations += Math.abs(change2 - change1);
        }
        jerkiness = variations / (magnitudeHistory.length - 2);
      }

      // DÃ©tection du type de mouvement
      if (smoothMagnitude > MIN_MOVEMENT) {
        if (jerkiness > JERKINESS_THRESHOLD) {
          // Mouvement saccadÃ©
          if (currentMode !== 'jerky') {
            startJerkyMode();
            if (navigator.vibrate) navigator.vibrate(100);
          }
        } else {
          // Mouvement fluide
          if (currentMode !== 'smooth') {
            startSmoothMode();
            if (navigator.vibrate) navigator.vibrate(50);
          }
        }
        resetModeTimeout();
      } else {
        // Pas assez de mouvement
        if (currentMode === 'smooth') {
          // En mode fluide, retour au noir si pas de mouvement
          stopSmoothMode();
        } else if (currentMode !== 'idle' && currentMode !== 'white_hold') {
          resetModeTimeout();
        }
      }
    }

    function resetModeTimeout() {
      clearTimeout(modeTimeout);
      modeTimeout = setTimeout(() => {
        if (currentMode !== 'white_hold') {
          stopAllModes();
        }
      }, 700);
    }

    function startSmoothMode() {
      if (currentMode === 'smooth') return;

      stopAllModes();
      currentMode = 'smooth';

      // Flash arc-en-ciel rapide et continu (20 couleurs)
      flashInterval = setInterval(() => {
        container.style.backgroundColor = rainbowColors[colorIndex];
        colorIndex = (colorIndex + 1) % rainbowColors.length;
      }, 80); // Flash rapide (80ms)
    }

    function stopSmoothMode() {
      if (flashInterval) {
        clearInterval(flashInterval);
        flashInterval = null;
      }
      currentMode = 'idle';
      container.style.backgroundColor = '#000000'; // Retour au noir
    }

    function startJerkyMode() {
      if (currentMode === 'jerky') return;

      stopAllModes();
      currentMode = 'jerky';
      jerkyStartTime = Date.now();
      jerkyStep = 0;

      // Progression toutes les 0.5 secondes
      updateJerkyProgression();
      progressionInterval = setInterval(updateJerkyProgression, 500);
    }

    function updateJerkyProgression() {
      if (currentMode !== 'jerky') return;

      const elapsed = Math.floor((Date.now() - jerkyStartTime) / 500);
      const step = Math.min(elapsed, jerkyColors.length - 1);

      container.style.backgroundColor = jerkyColors[step];
      jerkyStep = step;

      // Si on atteint le blanc, maintenir pendant 5 secondes
      if (step >= jerkyColors.length - 1) {
        clearInterval(progressionInterval);
        progressionInterval = null;
        currentMode = 'white_hold';

        // Maintenir le blanc pendant 5 secondes
        whiteTimeout = setTimeout(() => {
          container.style.backgroundColor = '#000000'; // Retour au noir
          currentMode = 'idle';
        }, 5000);
      }
    }

    function stopAllModes() {
      currentMode = 'idle';

      // ArrÃªter le flash rapide
      if (flashInterval) {
        clearInterval(flashInterval);
        flashInterval = null;
      }

      // ArrÃªter la progression
      if (progressionInterval) {
        clearInterval(progressionInterval);
        progressionInterval = null;
      }

      // ArrÃªter le timeout blanc
      if (whiteTimeout) {
        clearTimeout(whiteTimeout);
        whiteTimeout = null;
      }

      // Retour au noir
      if (currentMode !== 'white_hold') {
        container.style.backgroundColor = '#000000';
      }

      clearTimeout(modeTimeout);
    }

    // DÃ©marrage et reset
    startBtn.addEventListener('click', start, {passive: true});
    resetBtn.addEventListener('click', reset, {passive: true});

    // Nettoyage pÃ©riodique
    setInterval(() => {
      if (!running) return;
      if (currentMode === 'idle' && smoothMagnitude < MIN_MOVEMENT * 0.5) {
        container.style.backgroundColor = '#000000';
      }
    }, 500);

    // PWA - Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js');
      });
    }

    // EmpÃªcher zoom et scroll
    document.addEventListener('touchmove', (e) => {
      if (e.target !== resetBtn) {
        e.preventDefault();
      }
    }, {passive: false});
    document.addEventListener('gesturestart', (e) => e.preventDefault());
  </script>
</body>
</html>